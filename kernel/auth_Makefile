# IKOS Authentication & Authorization System Makefile
# Builds the complete authentication framework

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -g
INCLUDES = -I../include
LIBS = -lssl -lcrypto -lpthread
TARGET_DIR = ../build

# Source files
AUTH_SOURCES = auth_core.c auth_authorization.c auth_mfa.c
AUTH_OBJECTS = $(AUTH_SOURCES:.c=.o)
TEST_SOURCES = auth_test.c
TEST_OBJECTS = $(TEST_SOURCES:.c=.o)

# Targets
AUTH_LIB = $(TARGET_DIR)/libauth.a
TEST_BINARY = $(TARGET_DIR)/auth_test

.PHONY: all clean test install

all: $(AUTH_LIB) $(TEST_BINARY)

# Build static library
$(AUTH_LIB): $(AUTH_OBJECTS)
	@mkdir -p $(TARGET_DIR)
	ar rcs $@ $^
	@echo "Built authentication library: $@"

# Build test binary
$(TEST_BINARY): $(TEST_OBJECTS) $(AUTH_LIB)
	@mkdir -p $(TARGET_DIR)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)
	@echo "Built test binary: $@"

# Compile source files
%.o: %.c
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Run tests
test: $(TEST_BINARY)
	@echo "Running authentication system tests..."
	$(TEST_BINARY)

# Install headers and library
install: $(AUTH_LIB)
	@mkdir -p ../include/auth
	cp ../include/auth_system.h ../include/auth/
	@mkdir -p ../lib
	cp $(AUTH_LIB) ../lib/
	@echo "Installed authentication system"

# Clean build artifacts
clean:
	rm -f *.o
	rm -f $(AUTH_LIB) $(TEST_BINARY)
	@echo "Cleaned authentication build artifacts"

# Development targets
dev: CFLAGS += -DDEBUG -fsanitize=address
dev: all

# Documentation
docs:
	@echo "Generating authentication system documentation..."
	doxygen Doxyfile 2>/dev/null || echo "Doxygen not available, skipping docs"

# Static analysis
analyze:
	@echo "Running static analysis on authentication system..."
	cppcheck --enable=all --inconclusive --std=c99 $(AUTH_SOURCES) 2>/dev/null || echo "cppcheck not available"
	
# Memory leak check
valgrind: $(TEST_BINARY)
	@echo "Running memory leak analysis..."
	valgrind --leak-check=full --show-leak-kinds=all $(TEST_BINARY) 2>/dev/null || echo "Valgrind not available"

# Show help
help:
	@echo "IKOS Authentication System Build Targets:"
	@echo "  all      - Build authentication library and tests"
	@echo "  test     - Run authentication system tests"
	@echo "  install  - Install headers and library"
	@echo "  clean    - Clean build artifacts"
	@echo "  dev      - Build with debug flags"
	@echo "  docs     - Generate documentation"
	@echo "  analyze  - Run static analysis"
	@echo "  valgrind - Run memory leak analysis"
	@echo "  help     - Show this help message"
